// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "cockroachdb"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["views"]
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "../erd.md"
}

model User {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String    @unique
  passwordHash String    @map("password_hash")
  fullName     String    @map("full_name")
  Events       Event[]
  Charities    Charity[]

  @@map("users")
}

model Event {
  id             String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String
  slug           String               @unique
  startDate      DateTime             @map("start_date") @db.Date()
  endDate        DateTime             @map("end_date") @db.Date()
  location       String
  twitter        String?
  donationAmount Decimal              @default(3.00) @map("donation_amount")
  collectLeads   Boolean              @default(false) @map("collect_leads")
  legalBlurb     String?              @map("legal_blurb")
  tweetTemplate  String               @default("I just helped @CockroachDB donate {{donationAmount}} to {{charity}} at {{event}}.") @map("tweet_template")
  createdBy      String               @map("created_by") @db.Uuid
  createdAt      DateTime             @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt      DateTime             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()
  Creator        User                 @relation(fields: [createdBy], references: [id], onDelete: Restrict, onUpdate: Restrict)
  Charities      CharitiesForEvents[]
  Donations      Donation[]

  @@map("events")
}

model Charity {
  id          String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String
  description String
  website     String?
  twitter     String?
  logoSVG     String?              @map("logo_svg")
  createdBy   String               @map("created_by") @db.Uuid
  createdAt   DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  Creator     User                 @relation(fields: [createdBy], references: [id], onDelete: Restrict, onUpdate: Restrict)
  Events      CharitiesForEvents[]
  Donations   Donation[]

  @@map("charities")
}

model CharitiesForEvents {
  eventId   String  @map("event_id") @db.Uuid
  charityId String  @map("charity_id") @db.Uuid
  color     String
  Event     Event   @relation(fields: [eventId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  Charity   Charity @relation(fields: [charityId], references: [id], onDelete: Restrict, onUpdate: Restrict)

  @@id([eventId, charityId])
  @@map("charities_events")
}

enum SourceType {
  FORM @map("form")

  @@map("source_type")
}

enum LeadScore {
  BADGE_SCAN        @map("badge_scan")
  CONVERSATION      @map("conversation")
  MEETING_REQUESTED @map("meeting_requested")

  @@map("lead_score")
}

model Donation {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventId    String     @map("event_id") @db.Uuid
  charityId  String     @map("charity_id") @db.Uuid
  source     SourceType @default(FORM)
  sourceMeta Json?      @map("source_meta") @db.JsonB
  createdAt  DateTime   @default(now()) @map("created_at") @db.Timestamptz
  Lead       Lead?
  Event      Event      @relation(fields: [eventId], references: [id])
  Charity    Charity    @relation(fields: [charityId], references: [id])

  @@map("donations")
}

model Lead {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstName  String    @map("first_name")
  lastName   String    @map("last_name")
  email      String
  company    String
  jobRole    String    @map("job_role")
  score      LeadScore @default(BADGE_SCAN)
  notes      String?
  Donation   Donation  @relation(fields: [donationId], references: [id], onDelete: Cascade, onUpdate: Restrict)
  donationId String    @unique @map("donation_id") @db.Uuid

  @@map("leads")
}

view GroupedDonation {
  charity_id String @db.Uuid
  event_id   String @db.Uuid
  count      Int    @db.Int4

  @@unique([charity_id, event_id])
  @@map("grouped_donations")
}
